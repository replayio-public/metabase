name: E2E Tests

on:
  # We'll record runs using Replay.io and their browser on a schedule as an experiment
  schedule:
    - cron: "0 */8 * * *"
  push:
    branches:
      - "master"
      - "release-**"
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  test-run-id:
    runs-on: ubuntu-22.04
    outputs:
      testRunId: ${{ steps.testRunId.outputs.testRunId }}
    steps:
      - id: testRunId
        run: echo testRunId=$(npx uuid) >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    strategy:
      matrix:
        edition: [ee]
    env:
      MB_EDITION: ${{ matrix.edition }}
      INTERACTIVE: false
    steps:
      - uses: actions/checkout@v3
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
        with:
          m2-cache-key: e2e-tests

      - name: Cache uberjar
        id: cache-uberjar
        uses: actions/cache@v3
        with:
          path: ./target/uberjar/metabase.jar
          key: ${{ github.workflow }}-uberjar

      - name: Build uberjar with ./bin/build.sh
        if: steps.cache-uberjar.outputs.cache-hit != 'true'
        run: ./bin/build.sh

      - name: Prepare uberjar artifact
        uses: ./.github/actions/prepare-uberjar-artifact
